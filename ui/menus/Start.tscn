[gd_scene load_steps=6 format=2]

[ext_resource path="res://ui/theme/theme.tres" type="Theme" id=1]
[ext_resource path="res://ui/theme/checkbox_disabled.png" type="Texture" id=2]

[sub_resource type="StyleBoxFlat" id=1]
content_margin_left = 3.0
content_margin_right = 3.0
content_margin_top = 3.0
content_margin_bottom = 3.0
bg_color = Color( 0.737255, 0.737255, 0.737255, 1 )

[sub_resource type="GDScript" id=2]
script/source = "extends WindowContent

var current_mode
var current_mode_menu

var default_min_size = Vector2()

func _ready():
	$VBoxContainer/VBoxContainer/OptionButton.refresh()
	
	$VBoxContainer/PanelContainer/VBoxContainer/GridContainer/LineEdit.text = str(Game.config.get_value(\"server\", \"default_ping_listen_port\"))
	$VBoxContainer/PanelContainer/VBoxContainer/GridContainer/LineEdit2.text = str(Game.config.get_value(\"server\", \"default_rpc_host_port\"))
	$VBoxContainer/PanelContainer/VBoxContainer/GridContainer/LineEdit4.text = str(Game.config.get_value(\"server\", \"default_max_players\"))
	$VBoxContainer/PanelContainer/VBoxContainer/GridContainer/CheckBox2.pressed = Game.config.get_value(\"server\", \"default_use_websockets\")
	$VBoxContainer/PanelContainer/VBoxContainer/TextEdit.text = Game.config.get_value(\"server\", \"default_message\")
	
func _on_Button_pressed():
	var selectedMode = $VBoxContainer/VBoxContainer/OptionButton.paths[$VBoxContainer/VBoxContainer/OptionButton.selected]
	var modeSettings = current_mode_menu.get_settings()
	var ping_port = int($VBoxContainer/PanelContainer/VBoxContainer/GridContainer/LineEdit.text)
	var rpc_port = int($VBoxContainer/PanelContainer/VBoxContainer/GridContainer/LineEdit2.text)
	var ip = $VBoxContainer/PanelContainer/VBoxContainer/GridContainer/LineEdit3.text
	var max_players = int($VBoxContainer/PanelContainer/VBoxContainer/GridContainer/LineEdit4.text)
	var host_addons = $VBoxContainer/PanelContainer/VBoxContainer/GridContainer/CheckBox.pressed
	var websocket = $VBoxContainer/PanelContainer/VBoxContainer/GridContainer/CheckBox2.pressed
	var message = $VBoxContainer/PanelContainer/VBoxContainer/TextEdit.text
	
	if !$VBoxContainer/GridContainer/CheckBox.pressed:
		ip = Game.server.LOCALHOST  
	
	Game.peer.port = ping_port
	Game.peer.ip = ip
	Game.downloader.host_adddons = host_addons
	Game.server.max_players = max_players
	Game.server.port = rpc_port
	Game.server.ip = ip
	Game.server.message = message
	
	if websocket:
		Game.server.mode = Game.server.MODE_WEBSOCKET
	else:
		Game.server.mode = Game.server.MODE_CLASSIC
	
	var err = yield(Game.start_game(selectedMode, modeSettings),\"completed\")
	if err == OK:
		window.queue_free()

func _on_OptionButton_item_selected(id):
	for child in $VBoxContainer/ModeMenuContainer.get_children():
		$VBoxContainer/ModeMenuContainer.remove_child(child)
		child.queue_free()
	
	$VBoxContainer/HBoxContainer/Button.disabled = true
	
	var path = $VBoxContainer/VBoxContainer/OptionButton.paths[id]
	
	current_mode = load(path).new()
	
	if current_mode is GameMode:
		current_mode_menu = current_mode.menu
		current_mode_menu.connect(\"setting_changed\", self, \"_on_Mode_setting_changed\")
		$VBoxContainer/ModeMenuContainer.add_child(current_mode_menu)
		
func _on_Mode_setting_changed():
	if current_mode is GameMode:
		if current_mode_menu.valid:
			$VBoxContainer/HBoxContainer/Button.disabled = false
		else:
			$VBoxContainer/HBoxContainer/Button.disabled = true

func _on_CheckBox_toggled(button_pressed):
	if button_pressed:
		$VBoxContainer/PanelContainer/VBoxContainer.show()
		
		yield(get_tree(), \"idle_frame\")
		
		rect_min_size = rect_size
	else:
		$VBoxContainer/PanelContainer/VBoxContainer.hide()
		$VBoxContainer.rect_size = $VBoxContainer.rect_min_size
		rect_min_size = Vector2()
		rect_size = rect_min_size
		
		yield(get_tree(), \"idle_frame\")
		
		rect_min_size = rect_size
"

[sub_resource type="GDScript" id=3]
script/source = "extends OptionButton

var paths
	
func _on_OptionButton_pressed():
	refresh()
		
func refresh():
	var prev = selected
	clear()
	paths = Game.addons.get_modes()
	
	for i in paths:
		add_item(i)
	
	
	if paths.size() > 0:
		if !prev > paths.size() - 1:
			select(prev)
		else:
			select(paths.size() - 1)
			
		emit_signal(\"item_selected\", selected)
"

[node name="Start new game" type="PanelContainer"]
margin_right = 192.0
margin_bottom = 94.0
rect_min_size = Vector2( 192, 94 )
custom_styles/panel = SubResource( 1 )
script = SubResource( 2 )
__meta__ = {
"_edit_use_anchors_": false
}

[node name="VBoxContainer" type="VBoxContainer" parent="."]
margin_left = 3.0
margin_top = 3.0
margin_right = 539.0
margin_bottom = 78.0
size_flags_vertical = 0
__meta__ = {
"_edit_use_anchors_": false
}

[node name="VBoxContainer" type="HBoxContainer" parent="VBoxContainer"]
margin_right = 536.0
margin_bottom = 21.0

[node name="Label2" type="Label" parent="VBoxContainer/VBoxContainer"]
margin_top = 3.0
margin_right = 30.0
margin_bottom = 18.0
rect_min_size = Vector2( 30, 0 )
theme = ExtResource( 1 )
text = "Mode:"

[node name="OptionButton" type="OptionButton" parent="VBoxContainer/VBoxContainer"]
margin_left = 34.0
margin_right = 536.0
margin_bottom = 21.0
rect_min_size = Vector2( 150, 0 )
mouse_default_cursor_shape = 2
size_flags_horizontal = 3
theme = ExtResource( 1 )
text = " Choose Map.."
script = SubResource( 3 )

[node name="ModeMenuContainer" type="PanelContainer" parent="VBoxContainer"]
margin_top = 25.0
margin_right = 536.0
margin_bottom = 27.0
theme = ExtResource( 1 )

[node name="GridContainer" type="GridContainer" parent="VBoxContainer"]
margin_top = 31.0
margin_right = 536.0
margin_bottom = 47.0
columns = 2
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Label3" type="Label" parent="VBoxContainer/GridContainer"]
margin_right = 32.0
margin_bottom = 15.0
theme = ExtResource( 1 )
text = "Online:"

[node name="CheckBox" type="CheckBox" parent="VBoxContainer/GridContainer"]
margin_left = 36.0
margin_right = 52.0
margin_bottom = 16.0
mouse_default_cursor_shape = 2
theme = ExtResource( 1 )
__meta__ = {
"_edit_use_anchors_": false
}

[node name="PanelContainer" type="PanelContainer" parent="VBoxContainer"]
margin_top = 51.0
margin_right = 536.0
margin_bottom = 53.0
theme = ExtResource( 1 )

[node name="VBoxContainer" type="VBoxContainer" parent="VBoxContainer/PanelContainer"]
visible = false
margin_left = 1.0
margin_top = 1.0
margin_right = 535.0
margin_bottom = 185.0

[node name="GridContainer" type="GridContainer" parent="VBoxContainer/PanelContainer/VBoxContainer"]
margin_right = 534.0
margin_bottom = 143.0
columns = 2

[node name="Label" type="Label" parent="VBoxContainer/PanelContainer/VBoxContainer/GridContainer"]
margin_top = 1.0
margin_right = 117.0
margin_bottom = 16.0
text = "Ping Port(TCP):"

[node name="LineEdit" type="LineEdit" parent="VBoxContainer/PanelContainer/VBoxContainer/GridContainer"]
margin_left = 121.0
margin_right = 534.0
margin_bottom = 18.0
size_flags_horizontal = 3
caret_blink = true
caret_blink_speed = 0.5
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Label2" type="Label" parent="VBoxContainer/PanelContainer/VBoxContainer/GridContainer"]
margin_top = 23.0
margin_right = 117.0
margin_bottom = 38.0
text = "Game Port (UPD+TCP):"

[node name="LineEdit2" type="LineEdit" parent="VBoxContainer/PanelContainer/VBoxContainer/GridContainer"]
margin_left = 121.0
margin_top = 22.0
margin_right = 534.0
margin_bottom = 40.0
size_flags_horizontal = 3
caret_blink = true
caret_blink_speed = 0.5
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Label3" type="Label" parent="VBoxContainer/PanelContainer/VBoxContainer/GridContainer"]
margin_top = 45.0
margin_right = 117.0
margin_bottom = 60.0
text = "Bind IP:"

[node name="LineEdit3" type="LineEdit" parent="VBoxContainer/PanelContainer/VBoxContainer/GridContainer"]
margin_left = 121.0
margin_top = 44.0
margin_right = 534.0
margin_bottom = 62.0
size_flags_horizontal = 3
text = "*"
caret_blink = true
caret_blink_speed = 0.5
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Label5" type="Label" parent="VBoxContainer/PanelContainer/VBoxContainer/GridContainer"]
margin_top = 67.0
margin_right = 117.0
margin_bottom = 82.0
text = "Max Players (1-4095)"

[node name="LineEdit4" type="LineEdit" parent="VBoxContainer/PanelContainer/VBoxContainer/GridContainer"]
margin_left = 121.0
margin_top = 66.0
margin_right = 534.0
margin_bottom = 84.0
size_flags_horizontal = 3
caret_blink = true
caret_blink_speed = 0.5
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Label6" type="Label" parent="VBoxContainer/PanelContainer/VBoxContainer/GridContainer"]
margin_top = 88.0
margin_right = 117.0
margin_bottom = 103.0
text = "Host Addons:"

[node name="CheckBox" type="CheckBox" parent="VBoxContainer/PanelContainer/VBoxContainer/GridContainer"]
margin_left = 121.0
margin_top = 88.0
margin_right = 534.0
margin_bottom = 104.0
custom_icons/checked = ExtResource( 2 )
custom_colors/font_color_disabled = Color( 0.290196, 0.290196, 0.290196, 1 )
custom_colors/font_color = Color( 0.290196, 0.290196, 0.290196, 1 )
disabled = true
pressed = true
text = "When enabled any addons you have enabled will be downloaded by clients."

[node name="Label7" type="Label" parent="VBoxContainer/PanelContainer/VBoxContainer/GridContainer"]
margin_top = 108.0
margin_right = 117.0
margin_bottom = 123.0
text = "Use WebSockets:"

[node name="CheckBox2" type="CheckBox" parent="VBoxContainer/PanelContainer/VBoxContainer/GridContainer"]
margin_left = 121.0
margin_top = 108.0
margin_right = 534.0
margin_bottom = 124.0
custom_colors/font_color_disabled = Color( 0.290196, 0.290196, 0.290196, 1 )
text = "For compatibilty with Web clients, instead of native TCP+UDP comminucation. "

[node name="Label4" type="Label" parent="VBoxContainer/PanelContainer/VBoxContainer/GridContainer"]
margin_top = 128.0
margin_right = 117.0
margin_bottom = 143.0
text = "Server Message:"

[node name="TextEdit" type="LineEdit" parent="VBoxContainer/PanelContainer/VBoxContainer"]
margin_top = 147.0
margin_right = 534.0
margin_bottom = 165.0
rect_min_size = Vector2( 0, 18 )
theme = ExtResource( 1 )
caret_blink = true
caret_blink_speed = 0.5

[node name="Label4" type="Label" parent="VBoxContainer/PanelContainer/VBoxContainer"]
margin_top = 169.0
margin_right = 534.0
margin_bottom = 184.0
custom_colors/font_color = Color( 0.235294, 0.235294, 0.235294, 1 )
text = "IP: * stands for all interfaces on this device."

[node name="HBoxContainer" type="HBoxContainer" parent="VBoxContainer"]
margin_top = 57.0
margin_right = 536.0
margin_bottom = 75.0
alignment = 2
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Button" type="Button" parent="VBoxContainer/HBoxContainer"]
margin_left = 505.0
margin_right = 536.0
margin_bottom = 18.0
mouse_default_cursor_shape = 2
theme = ExtResource( 1 )
disabled = true
text = "Start"
__meta__ = {
"_edit_use_anchors_": false
}
[connection signal="item_selected" from="VBoxContainer/VBoxContainer/OptionButton" to="." method="_on_OptionButton_item_selected"]
[connection signal="pressed" from="VBoxContainer/VBoxContainer/OptionButton" to="VBoxContainer/VBoxContainer/OptionButton" method="_on_OptionButton_pressed"]
[connection signal="toggled" from="VBoxContainer/GridContainer/CheckBox" to="." method="_on_CheckBox_toggled"]
[connection signal="pressed" from="VBoxContainer/HBoxContainer/Button" to="." method="_on_Button_pressed"]
